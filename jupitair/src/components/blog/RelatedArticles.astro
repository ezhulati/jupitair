---
/**
 * Related Articles Component for Jupitair HVAC Blog
 * Features: Smart recommendations, performance optimized, accessible
 */
import { getCollection } from 'astro:content';

interface Props {
  posts: string[];
  currentSlug?: string;
  maxItems?: number;
  showImages?: boolean;
  className?: string;
}

const { 
  posts, 
  currentSlug, 
  maxItems = 3, 
  showImages = true, 
  className = '' 
} = Astro.props;

// Get blog posts
const allBlogPosts = await getCollection('blog');

// Filter and format related posts
const relatedPosts = posts
  .slice(0, maxItems)
  .map(slug => {
    const post = allBlogPosts.find(p => p.slug === slug);
    if (!post) return null;
    
    return {
      slug: post.slug,
      title: post.data.title,
      description: post.data.description,
      category: post.data.category,
      readingTime: post.data.readingTime || 5,
      heroImage: post.data.heroImage,
      heroImageAlt: post.data.heroImageAlt,
      publishDate: post.data.publishDate,
      isEmergency: post.data.category.toLowerCase().includes('emergency') || 
                   post.data.tags?.some((tag: string) => tag.toLowerCase().includes('emergency'))
    };
  })
  .filter(Boolean)
  .filter(post => post?.slug !== currentSlug);

// If no related posts provided, get recent posts from same category
if (relatedPosts.length === 0 && currentSlug) {
  const currentPost = allBlogPosts.find(p => p.slug === currentSlug);
  const sameCategory = allBlogPosts
    .filter(p => p.slug !== currentSlug && p.data.category === currentPost?.data.category)
    .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
    .slice(0, maxItems)
    .map(post => ({
      slug: post.slug,
      title: post.data.title,
      description: post.data.description,
      category: post.data.category,
      readingTime: post.data.readingTime || 5,
      heroImage: post.data.heroImage,
      heroImageAlt: post.data.heroImageAlt,
      publishDate: post.data.publishDate,
      isEmergency: post.data.category.toLowerCase().includes('emergency') || 
                   post.data.tags?.some((tag: string) => tag.toLowerCase().includes('emergency'))
    }));
  
  relatedPosts.push(...sameCategory);
}

// Format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  }).format(date);
};
---

{relatedPosts.length > 0 && (
  <section class={`related-articles bg-white rounded-lg border border-gray-200 shadow-sm ${className}`}>
    <!-- Header -->
    <div class="p-5 border-b border-gray-100">
      <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
        </svg>
        Related Articles
      </h3>
      <p class="text-sm text-gray-600 mt-1">
        More helpful HVAC insights from our experts
      </p>
    </div>

    <!-- Articles List -->
    <div class="divide-y divide-gray-100">
      {relatedPosts.map((post, index) => (
        <article class="related-article-item group">
          <a 
            href={`/blog/${post.slug}`}
            class="flex gap-4 p-4 hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-inset"
            aria-label={`Read article: ${post.title}`}
          >
            <!-- Article Image -->
            {showImages && post.heroImage && (
              <div class="flex-shrink-0">
                <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden bg-gray-100">
                  <img 
                    src={post.heroImage}
                    alt={post.heroImageAlt || post.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              </div>
            )}

            <!-- Article Content -->
            <div class="flex-1 min-w-0">
              <!-- Emergency badge -->
              {post.isEmergency && (
                <div class="mb-2">
                  <span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium">
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                    Emergency
                  </span>
                </div>
              )}

              <!-- Title -->
              <h4 class="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-2 text-sm sm:text-base mb-1">
                {post.title}
              </h4>

              <!-- Description -->
              <p class="text-gray-600 text-xs sm:text-sm line-clamp-2 mb-2 leading-relaxed">
                {post.description}
              </p>

              <!-- Meta information -->
              <div class="flex items-center gap-3 text-xs text-gray-500">
                <!-- Category -->
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                    <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                  </svg>
                  {post.category}
                </span>

                <!-- Reading time -->
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  {post.readingTime} min
                </span>

                <!-- Date -->
                <time datetime={post.publishDate.toISOString()}>
                  {formatDate(post.publishDate)}
                </time>
              </div>
            </div>

            <!-- Arrow indicator -->
            <div class="flex-shrink-0 self-center">
              <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-600 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        </article>
      ))}
    </div>

    <!-- View All Articles Link -->
    <div class="p-4 border-t border-gray-100 bg-gray-50">
      <a 
        href="/blog"
        class="flex items-center justify-center gap-2 text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
        </svg>
        View All HVAC Articles
      </a>
    </div>
  </section>
)}

<style>
  /* Line clamping for consistent layout */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Hover effects */
  .related-article-item:hover {
    background-color: rgba(249, 250, 251, 0.8);
  }
  
  /* Focus styles for accessibility */
  .related-article-item a:focus {
    background-color: rgba(59, 130, 246, 0.05);
  }
  
  /* Loading state for images */
  .related-article-item img {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .related-article-item img[src=""] {
    opacity: 0;
  }
  
  /* Mobile responsive adjustments */
  @media (max-width: 640px) {
    .related-articles {
      margin: 0 -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
  }
  
  /* Print styles */
  @media print {
    .related-articles {
      break-inside: avoid;
      border: 1px solid #000;
    }
    
    .related-article-item a {
      color: #000 !important;
      text-decoration: none;
    }
    
    .related-article-item img {
      display: none;
    }
  }
  
  /* High contrast mode */
  @media (prefers-contrast: high) {
    .related-articles {
      border-width: 2px;
    }
    
    .related-article-item {
      border-bottom-width: 2px;
    }
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .related-article-item img {
      transition: none;
    }
    
    .related-article-item svg {
      transition: none;
    }
    
    .related-article-item:hover img {
      transform: none;
    }
    
    .related-article-item:hover svg {
      transform: none;
    }
  }
</style>