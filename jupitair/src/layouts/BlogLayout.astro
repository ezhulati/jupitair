---
import BaseLayout from './BaseLayout.astro';
import PremiumCard from '../components/ui/PremiumCard.astro';
import Card from '../components/ui/Card.astro';
import Badge from '../components/ui/Badge.astro';
import Button from '../components/ui/Button.astro';
import PremiumButton from '../components/ui/PremiumButton.astro';
import PhoneLink from '../components/ui/PhoneLink.astro';
import DynamicSchema from '../components/seo/DynamicSchema.astro';
import { Image } from 'astro:assets';

export interface Props {
  frontmatter: {
    title: string;
    description: string;
    author: string;
    publishDate: Date;
    updateDate?: Date;
    heroImage?: string;
    heroImageAlt?: string;
    category: string;
    subcategory?: string;
    tags: string[];
    featured: boolean;
    metaTitle?: string;
    metaDescription?: string;
    primaryKeyword: string;
    secondaryKeywords: string[];
    canonicalURL?: string;
    readingTime?: number;
    tableOfContents?: boolean;
    schemaTypes?: string[];
    ctaText?: string;
    ctaLink?: string;
    relatedPosts?: string[];
    internalLinks?: string[];
  };
}

const { frontmatter } = Astro.props;
const formattedPublishDate = new Date(frontmatter.publishDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
const formattedUpdateDate = frontmatter.updateDate ? new Date(frontmatter.updateDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) : null;

// Generate breadcrumb data
const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Resources', url: '/blog' },
  { name: frontmatter.category, url: `/blog/category/${frontmatter.category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-')}` },
  { name: frontmatter.title, url: '#' }
];

// Schema data for blog post
const blogSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": frontmatter.title,
  "description": frontmatter.description,
  "author": {
    "@type": "Organization",
    "name": frontmatter.author,
    "url": "https://jupitairhvac.com"
  },
  "datePublished": frontmatter.publishDate,
  "dateModified": frontmatter.updateDate || frontmatter.publishDate,
  "image": frontmatter.heroImage ? `https://jupitairhvac.com${frontmatter.heroImage}` : undefined,
  "publisher": {
    "@type": "Organization",
    "name": "Jupitair HVAC",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jupitairhvac.com/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": frontmatter.canonicalURL || `https://jupitairhvac.com/blog/${frontmatter.title.toLowerCase().replace(/\s+/g, '-')}`
  },
  "keywords": [frontmatter.primaryKeyword, ...frontmatter.secondaryKeywords].join(', ')
};
---

<style>
  /* Smooth animation for details/summary */
  details > summary {
    transition: color 0.2s ease;
  }
  
  details > summary:hover {
    color: #2563eb;
  }
  
  details[open] > div {
    animation: slideDown 0.3s ease-out;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Better focus styles for accessibility */
  details > summary:focus-visible {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
    border-radius: 4px;
  }
</style>

<BaseLayout 
  title={frontmatter.metaTitle || `${frontmatter.title} | Jupitair HVAC Blog`}
  description={frontmatter.metaDescription || frontmatter.description}
  keywords={[frontmatter.primaryKeyword, ...frontmatter.secondaryKeywords].join(', ')}
  canonical={frontmatter.canonicalURL}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(blogSchema)} />
  
  <!-- Breadcrumbs Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://jupitairhvac.com/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Blog",
        "item": "https://jupitairhvac.com/blog"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": frontmatter.category,
        "item": `https://jupitairhvac.com/blog/category/${frontmatter.category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-')}`
      },
      {
        "@type": "ListItem",
        "position": 4,
        "name": frontmatter.title
      }
    ]
  })} />

  <article class="w-full px-4 sm:px-6 lg:px-8 xl:px-12 pt-[170px] pb-16">
    <!-- Article container with better responsive padding -->
    <div class="max-w-[1600px] mx-auto">
    <!-- Breadcrumbs -->
    <nav class="mb-8 overflow-x-auto" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm whitespace-nowrap">
        {breadcrumbs.slice(0, -1).map((crumb, index) => (
          <>
            {index > 0 && <span class="text-gray-400">/</span>}
            <li>
              <a href={crumb.url} class="text-gray-600 hover:text-gray-900 transition-colors">
                {crumb.name}
              </a>
            </li>
          </>
        ))}
      </ol>
    </nav>

    <!-- Article Header -->
    <header class="mb-12 max-w-5xl">
      <h1 class="break-words text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
        {frontmatter.title}
      </h1>
      
      <p class="break-words text-xl md:text-2xl text-gray-700 mb-8 leading-relaxed">
        {frontmatter.description}
      </p>
      
      <div class="min-w-0 flex flex-wrap items-center gap-4 text-sm text-gray-600">
        <div class="min-w-0 flex items-center gap-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
          </svg>
          <span>{frontmatter.author}</span>
        </div>
        <div class="min-w-0 flex items-center gap-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
          </svg>
          <time datetime={frontmatter.updateDate ? frontmatter.updateDate.toISOString() : frontmatter.publishDate.toISOString()}>
            {formattedUpdateDate || formattedPublishDate}
          </time>
        </div>
        {frontmatter.readingTime && (
          <div class="min-w-0 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
            </svg>
            <span>{frontmatter.readingTime} min read</span>
          </div>
        )}
      </div>
    </header>

    <!-- Mobile Hero Image (shown only on mobile) -->
    {frontmatter.heroImage && (
      <div class="lg:hidden mb-8">
        <div class="rounded-2xl overflow-hidden shadow-xl mx-auto">
          <img 
            src={frontmatter.heroImage} 
            alt={frontmatter.heroImageAlt || frontmatter.title}
            class="w-full h-auto aspect-[16/10] object-cover"
            loading="eager"
          />
        </div>
      </div>
    )}

    <!-- Main Content Grid with better proportions -->
    <div class="grid lg:grid-cols-12 gap-8">
      <!-- Main Content - takes up more space -->
      <div class="lg:col-span-8 xl:col-span-9">
        <!-- Desktop Table of Contents -->
        {frontmatter.tableOfContents && (
          <div class="hidden lg:block mb-8">
            <details class="group">
              <summary class="cursor-pointer list-none flex items-center gap-2 text-lg font-semibold text-gray-900 mb-4 hover:text-gray-700">
                <svg class="w-5 h-5 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                Table of Contents
              </summary>
              <div id="toc" class="ml-7 text-sm space-y-2">
                <!-- TOC will be generated by client-side script -->
              </div>
            </details>
          </div>
        )}

        <!-- Mobile Table of Contents -->
        {frontmatter.tableOfContents && (
          <div class="lg:hidden mb-8">
            <Card variant="outline"  class="border-gray-200 bg-white">
              <details class="group">
                <summary class="cursor-pointer list-none flex items-center gap-2 text-xl font-bold text-gray-900 mb-4">
                  <svg class="w-5 h-5 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                  Table of Contents
                </summary>
                <div id="toc-mobile" class="ml-7 text-sm space-y-2">
                  <!-- TOC will be generated by client-side script -->
                </div>
              </details>
            </Card>
          </div>
        )}
        <div class="prose prose-lg lg:prose-xl max-w-none
          prose-headings:font-bold prose-headings:text-gray-900 
          prose-h1:text-3xl sm:prose-h1:text-4xl lg:prose-h1:text-5xl prose-h1:mt-8 prose-h1:mb-6 prose-h1:leading-tight
          prose-h2:text-2xl sm:prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:leading-snug
          prose-h3:text-xl sm:prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:leading-snug
          prose-h4:text-lg sm:prose-h4:text-xl prose-h4:mt-6 prose-h4:mb-3
          prose-p:text-base sm:prose-p:text-lg prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
          prose-a:text-blue-600 hover:prose-a:text-blue-700 prose-a:underline prose-a:underline-offset-2
          prose-strong:text-gray-900 prose-strong:font-semibold
          prose-ul:my-6 prose-ul:list-disc prose-ul:pl-6 prose-ul:space-y-2
          prose-ol:my-6 prose-ol:list-decimal prose-ol:pl-6 prose-ol:space-y-2
          prose-li:text-gray-700 prose-li:leading-relaxed
          prose-blockquote:border-l-4 prose-blockquote:border-blue-500 prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-700 prose-blockquote:my-8
          prose-code:bg-gray-100 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-sm prose-code:text-gray-800 prose-code:font-mono
          prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:overflow-x-auto prose-pre:rounded-lg prose-pre:p-4 prose-pre:my-8
          prose-table:w-full prose-table:border-collapse prose-table:my-8
          prose-th:bg-gray-100 prose-th:text-left prose-th:p-3 prose-th:border prose-th:border-gray-300 prose-th:font-semibold
          prose-td:border prose-td:border-gray-300 prose-td:p-3
          prose-img:rounded-lg prose-img:shadow-lg prose-img:my-8 prose-img:w-full
          prose-hr:border-gray-300 prose-hr:my-12">
          <slot />
        </div>

        <!-- Author Bio -->
        <div class="mt-16 mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
          <h3 class="font-bold text-gray-900 mb-2">About the Author</h3>
          <p class="text-gray-700">
            The Jupitair HVAC Team consists of licensed HVAC technicians and comfort specialists with over 15 years of experience serving North Texas. We're committed to providing honest, expert advice to help homeowners make informed decisions about their heating and cooling systems.
          </p>
        </div>

        <!-- Tags -->
        {frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="mt-8">
            <h3 class="font-bold text-gray-900 mb-4">Topics:</h3>
            <div class="min-w-0 flex flex-wrap gap-2">
              {frontmatter.tags.map(tag => (
                <span 
                  class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm"
                >
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Right Sidebar - takes up less space -->
      <aside class="lg:col-span-4 xl:col-span-3">
        <!-- Position sidebar content to align with TOC -->
        <div class="lg:mt-[60px]">
          <div class="sticky top-32 space-y-6">
            <!-- Desktop Hero Image -->
            {frontmatter.heroImage && (
              <div class="hidden lg:block rounded-lg overflow-hidden border border-gray-200">
                <img 
                  src={frontmatter.heroImage} 
                  alt={frontmatter.heroImageAlt || frontmatter.title}
                  class="w-full h-auto aspect-[16/10] object-cover"
                  loading="eager"
                />
              </div>
            )}
            
            <!-- Categories -->
          <div class="bg-white rounded-lg border border-gray-200 p-5 mb-6">
            <h3 class="text-base font-bold text-gray-900 mb-3">Categories</h3>
            <div class="flex flex-wrap gap-2">
              <a href={`/blog/category/${frontmatter.category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-')}`}>
                <Badge variant="primary" class="hover:opacity-80 transition-opacity cursor-pointer">
                  {frontmatter.category}
                </Badge>
              </a>
              {frontmatter.subcategory && (
                <Badge variant="secondary">{frontmatter.subcategory}</Badge>
              )}
              {frontmatter.featured && (
                <Badge variant="success">Featured</Badge>
              )}
            </div>
          </div>
          
          <!-- CTA Card -->
          <div class="bg-gray-50 rounded-lg border border-gray-200 p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Need HVAC Service?</h3>
            <p class="text-gray-700 mb-6">
              Get fast, reliable service from North Texas's trusted HVAC experts.
            </p>
            <div class="space-y-3">
              <PhoneLink 
                variant="premium" 
                size="lg" 
                context="blog"
                showIcon={false}
                class="w-full justify-center"
              />
              <Button 
                href={frontmatter.ctaLink || '/schedule'} 
                variant="outline" 
                size="lg" 
                class="w-full justify-center"
              >
                {frontmatter.ctaText || 'Schedule Online'}
              </Button>
            </div>
            <p class="text-xs text-gray-600 mt-4 text-center">
              24/7 Emergency Service Available
            </p>
          </div>

          <!-- Related Posts -->
          {frontmatter.relatedPosts && frontmatter.relatedPosts.length > 0 && (
            <div class="bg-white rounded-lg border border-gray-200 p-5">
              <h3 class="text-base font-bold text-gray-900 mb-3">Related Articles</h3>
              <ul class="space-y-2">
                {frontmatter.relatedPosts.slice(0, 3).map(post => (
                  <li>
                    <a 
                      href={`/blog/${post}`}
                      class="text-blue-600 hover:text-blue-700 hover:underline block text-sm leading-relaxed"
                    >
                      {post.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}
          </div>
        </div>
      </aside>
    </div>
    </div>
  </article>

  <!-- Generate TOC Script -->
  {frontmatter.tableOfContents && (
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const tocContainers = [document.getElementById('toc'), document.getElementById('toc-mobile')];
        const headings = document.querySelectorAll('.prose h2, .prose h3');
        
        tocContainers.forEach(tocContainer => {
          if (tocContainer && headings.length > 0) {
            const tocList = document.createElement('ul');
            tocList.className = 'space-y-2 text-sm';
            
            headings.forEach((heading, index) => {
              const id = heading.id || `heading-${index}`;
              heading.id = id;
              
              const li = document.createElement('li');
              li.className = heading.tagName === 'H3' ? 'ml-4' : '';
              
              const link = document.createElement('a');
              link.href = `#${id}`;
              link.textContent = heading.textContent;
              link.className = 'text-blue-600 hover:text-blue-700 hover:underline block py-1';
              
              li.appendChild(link);
              tocList.appendChild(li);
            });
            
            tocContainer.appendChild(tocList.cloneNode(true));
          }
        });
      });
    </script>
  )}
</BaseLayout>
