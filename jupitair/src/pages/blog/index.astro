---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PremiumHero from '../../components/layout/PremiumHero.astro';
import Card from '../../components/ui/Card.astro';
import PremiumCard from '../../components/ui/PremiumCard.astro';
import Button from '../../components/ui/Button.astro';
import Badge from '../../components/ui/Badge.astro';

// Fetch all blog posts from content collection
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Sort posts by publish date (newest first)
const sortedPosts = allPosts.sort((a, b) => {
  return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
});

// Get featured posts
const featuredPosts = sortedPosts.filter(post => post.data.featured === true);
const featuredPost = featuredPosts[0] || sortedPosts[0];

// Get categories with counts
const categoryCounts = new Map();
sortedPosts.forEach(post => {
  const category = post.data.category;
  categoryCounts.set(category, (categoryCounts.get(category) || 0) + 1);
});

const categories = [
  { name: 'All Posts', count: sortedPosts.length },
  ...Array.from(categoryCounts.entries())
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => b.count - a.count)
];

// Get popular posts (ones with 'cost', 'emergency', or 'repair' in title)
const popularPosts = sortedPosts
  .filter(post => 
    post.data.title.toLowerCase().includes('cost') ||
    post.data.title.toLowerCase().includes('emergency') ||
    post.data.title.toLowerCase().includes('repair') ||
    post.data.title.toLowerCase().includes('save') ||
    post.data.featured
  )
  .slice(0, 5);

// Pagination setup
const postsPerPage = 9;
const currentPage = 1;
const totalPages = Math.ceil(sortedPosts.length / postsPerPage);
const paginatedPosts = sortedPosts.slice(0, postsPerPage);

// Format date helper
function formatDate(date: Date | string) {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Generate category slug
function getCategorySlug(category: string) {
  return category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-');
}
---

<BaseLayout
  title="HVAC Blog & Resources | Tips, Guides & Industry News | Jupitair"
  description="Expert HVAC tips, maintenance guides, and industry insights for North Texas homeowners and businesses. Learn how to save energy, maintain your system, and more."
  keywords="HVAC blog, AC maintenance tips, heating guides, energy saving HVAC, North Texas HVAC advice"
  canonical="https://jupitairhvac.com/blog"
>
  <!-- Premium Hero Section -->
  <PremiumHero 
    title="HVAC Tips & Resources"
    subtitle="Expert Insights for North Texas"
    description="Get expert advice on maintaining your HVAC system, saving energy, and keeping your home or business comfortable year-round."
    ctaPrimary={{ text: "Get Free Quote", href: "/contact" }}
    ctaSecondary={{ text: "Get Quote", href: "/schedule" }}
    variant="gradient"
    height="md"
  />

  <!-- Blog Content -->
  <section class="py-16 bg-white">
    <div class="max-w-7xl overflow-x-hidden container mx-auto px-4">
      <div class="max-w-7xl mx-auto">
        <div class="min-w-0 grid lg:grid-cols-3 gap-8">
          
          <!-- Main Content -->
          <div class="lg:col-span-2">
            <!-- Featured Post -->
            {featuredPost && (
              <div class="mb-12">
                <Badge variant="primary" class="mb-4">Featured Post</Badge>
                <PremiumCard variant="elevated" padding="none" class="overflow-hidden hover:shadow-2xl transition-all">
                  {featuredPost.data.heroImage && (
                    <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                      <img 
                        src={featuredPost.data.heroImage} 
                        alt={featuredPost.data.heroImageAlt || featuredPost.data.title}
                        class="w-full h-64 object-cover"
                      />
                    </div>
                  )}
                  {!featuredPost.data.heroImage && (
                    <div class="w-full h-64 bg-gradient-to-br from-primary-100 to-primary-200"></div>
                  )}
                  <div class="p-8">
                    <div class="min-w-0 flex items-center gap-4 text-sm text-gray-600 mb-4">
                      <span>{formatDate(featuredPost.data.publishDate)}</span>
                      <span>â€¢</span>
                      <span>{featuredPost.data.readingTime || 5} min read</span>
                      <span>â€¢</span>
                      <Badge variant="secondary" size="sm">{featuredPost.data.category}</Badge>
                    </div>
                    <h2 class="break-words text-2xl font-bold text-gray-900 mb-3">
                      {featuredPost.data.title}
                    </h2>
                    <p class="text-gray-600 mb-6">
                      {featuredPost.data.description}
                    </p>
                    <Button href={`/blog/${featuredPost.slug}`} variant="primary" size="md">
                      Read More â†’
                    </Button>
                  </div>
                </PremiumCard>
              </div>
            )}

            <!-- Recent Posts Grid -->
            <div class="min-w-0 grid md:grid-cols-2 gap-6">
              {paginatedPosts.slice(1).map(post => (
                <Card variant="elevated" padding="lg" class="hover:shadow-xl transition-shadow">
                  <div class="min-w-0 flex items-start justify-between mb-3">
                    <Badge variant="secondary" size="sm">{post.data.category}</Badge>
                    <span class="text-xs text-gray-500">{post.data.readingTime || 5} min read</span>
                  </div>
                  <h3 class="text-lg font-bold text-gray-900 mb-2">
                    <a href={`/blog/${post.slug}`} class="hover:text-primary-600 transition-colors">
                      {post.data.title}
                    </a>
                  </h3>
                  <p class="text-sm text-gray-600 mb-4">{post.data.description}</p>
                  <div class="min-w-0 flex items-center justify-between">
                    <span class="text-xs text-gray-500">{formatDate(post.data.publishDate)}</span>
                    <a href={`/blog/${post.slug}`} class="text-primary-600 hover:text-primary-700 font-medium text-sm">
                      Read â†’
                    </a>
                  </div>
                </Card>
              ))}
            </div>

            <!-- Pagination -->
            <div class="min-w-0 mt-12 flex items-center justify-center gap-2">
              <Button variant="outline" size="sm" disabled={true}>Previous</Button>
              <span class="px-4 py-2 text-sm font-medium">Page {currentPage} of {totalPages}</span>
              {totalPages > 1 ? (
                <Button href="/blog/page/2" variant="outline" size="sm">Next</Button>
              ) : (
                <Button variant="outline" size="sm" disabled={true}>Next</Button>
              )}
            </div>
          </div>

          <!-- Sidebar -->
          <div class="lg:col-span-1">
            <!-- Search -->
            <Card variant="elevated" padding="lg" class="mb-6">
              <h3 class="font-bold text-gray-900 mb-4">Search Articles</h3>
              <div class="relative">
                <input 
                  type="search" 
                  placeholder="Search blog posts..."
                  class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
                <button class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                  </svg>
                </button>
              </div>
            </Card>

            <!-- Categories -->
            <Card variant="elevated" padding="lg" class="mb-6">
              <h3 class="font-bold text-gray-900 mb-4">Categories</h3>
              <ul class="space-y-2">
                {categories.slice(0, 8).map(category => (
                  <li>
                    <a href={category.name === 'All Posts' ? '/blog' : `/blog/category/${getCategorySlug(category.name)}`} 
                       class="min-w-0 flex items-center justify-between text-gray-600 hover:text-primary-600 transition-colors">
                      <span>{category.name}</span>
                      <span class="text-sm text-gray-400">({category.count})</span>
                    </a>
                  </li>
                ))}
              </ul>
            </Card>

            <!-- Popular Posts -->
            <Card variant="elevated" padding="lg" class="mb-6">
              <h3 class="font-bold text-gray-900 mb-4">Popular Posts</h3>
              <ul class="space-y-3">
                {popularPosts.map((post, index) => (
                  <li class="min-w-0 flex items-start gap-3">
                    <span class="break-words text-2xl font-bold text-primary-600">{index + 1}</span>
                    <a href={`/blog/${post.slug}`} class="text-sm text-gray-600 hover:text-primary-600 transition-colors">
                      {post.data.title}
                    </a>
                  </li>
                ))}
              </ul>
            </Card>

            <!-- Newsletter CTA -->
            <PremiumCard variant="gradient" padding="lg">
              <div class="text-center">
                <div class="break-words text-3xl mb-3">ðŸ“§</div>
                <h3 class="font-bold text-gray-900 mb-2">HVAC Tips Newsletter</h3>
                <p class="text-sm text-gray-600 mb-4">
                  Get monthly maintenance tips and exclusive offers
                </p>
                <input 
                  type="email" 
                  placeholder="Your email"
                  class="w-full px-4 py-2 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                />
                <Button variant="primary" size="sm" class="w-full">
                  Subscribe
                </Button>
              </div>
            </PremiumCard>

            <!-- Need Help CTA -->
            <Card variant="elevated" padding="lg" class="mt-6 bg-emergency-50 border-2 border-emergency-200">
              <div class="text-center">
                <div class="break-words text-3xl mb-3">ðŸš¨</div>
                <h3 class="font-bold text-gray-900 mb-2">HVAC Emergency?</h3>
                <p class="text-sm text-gray-600 mb-4">
                  We're available 24/7 for emergency repairs
                </p>
                <Button href="tel:9403905676" variant="emergency" size="sm" class="w-full">
                  Call (940) 390-5676
                </Button>
              </div>
            </Card>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Related Services CTA -->
  <section class="py-16 bg-gray-50">
    <div class="max-w-7xl overflow-x-hidden container mx-auto px-4">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="break-words text-3xl font-bold text-gray-900 mb-4">
          Need Professional HVAC Service?
        </h2>
        <p class="break-words text-xl text-gray-600 mb-8">
          Our expert technicians are ready to help with all your heating and cooling needs
        </p>
        <div class="min-w-0 flex flex-col sm:flex-row gap-4 justify-center">
          <Button href="/contact" variant="primary" size="lg">
            Get Quote
          </Button>
          <Button href="/contact" variant="outline" size="lg">
            Get Free Quote
          </Button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>