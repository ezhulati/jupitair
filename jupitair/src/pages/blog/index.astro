---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Badge from '../../components/ui/Badge.astro';

// Fetch all blog posts from content collection
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Sort posts by publish date (newest first)
const sortedPosts = allPosts.sort((a, b) => {
  return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
});

// Get featured posts
const featuredPosts = sortedPosts.filter(post => post.data.featured === true);
const featuredPost = featuredPosts[0] || sortedPosts[0];

// Get categories with counts
const categoryCounts = new Map();
sortedPosts.forEach(post => {
  const category = post.data.category;
  categoryCounts.set(category, (categoryCounts.get(category) || 0) + 1);
});

const categories = [
  { name: 'All Posts', count: sortedPosts.length },
  ...Array.from(categoryCounts.entries())
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => b.count - a.count)
];

// Get popular posts (ones with 'cost', 'emergency', or 'repair' in title)
const popularPosts = sortedPosts
  .filter(post => 
    post.data.title.toLowerCase().includes('cost') ||
    post.data.title.toLowerCase().includes('emergency') ||
    post.data.title.toLowerCase().includes('repair') ||
    post.data.title.toLowerCase().includes('save') ||
    post.data.featured
  )
  .slice(0, 5);

// Pagination setup
const postsPerPage = 9;
const currentPage = 1;
const totalPages = Math.ceil(sortedPosts.length / postsPerPage);
const paginatedPosts = sortedPosts.slice(0, postsPerPage);

// Format date helper
function formatDate(date: Date | string) {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Generate category slug
function getCategorySlug(category: string) {
  return category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-');
}
---

<BaseLayout
  title="HVAC Resources | Tips, Guides & Industry Knowledge | Jupitair"
  description="Expert HVAC tips, maintenance guides, and industry insights for North Texas homeowners and businesses. Learn how to save energy, maintain your system, and more."
  keywords="HVAC blog, AC maintenance tips, heating guides, energy saving HVAC, North Texas HVAC advice"
  canonical="https://jupitairhvac.com/blog"
  overlayHeader={true}
>
  <!-- Hero Section - CONSISTENT DESIGN SYSTEM -->
  <section class="section-full bg-gradient-to-br from-primary-600 to-primary-800">
    <div class="site-container section-padding">
      <div class="text-center">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4">
          HVAC Resources
        </h1>
        <p class="text-base sm:text-lg lg:text-xl text-white/90 max-w-3xl mx-auto">
          Expert advice on maintaining your HVAC system, saving energy, and keeping your home comfortable year-round
        </p>
      </div>
    </div>
  </section>

  <!-- Resources Content - CONSISTENT DESIGN SYSTEM -->
  <section class="section-full bg-white">
    <div class="site-container section-padding">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
        
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <!-- Featured Post -->
          {featuredPost && (
            <div class="mb-8 sm:mb-12">
              <div class="mb-3">
                <Badge variant="emergency">Featured Article</Badge>
              </div>
              <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow">
                {featuredPost.data.heroImage ? (
                  <img 
                    src={featuredPost.data.heroImage} 
                    alt={featuredPost.data.heroImageAlt || featuredPost.data.title}
                    class="w-full h-48 sm:h-64 object-cover"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-48 sm:h-64 bg-gradient-to-br from-primary-100 to-primary-200"></div>
                )}
                <div class="p-6 sm:p-8">
                  <div class="flex flex-wrap items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-600 mb-3">
                    <span>{formatDate(featuredPost.data.publishDate)}</span>
                    <span>•</span>
                    <span>{featuredPost.data.readingTime || 5} min read</span>
                    <span>•</span>
                    <Badge variant="primary" size="sm">{featuredPost.data.category}</Badge>
                  </div>
                  <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3">
                    {featuredPost.data.title}
                  </h2>
                  <p class="text-gray-700 mb-6 line-clamp-3">
                    {featuredPost.data.description}
                  </p>
                  <Button href={`/blog/${featuredPost.slug}`} variant="primary">
                    Read Full Article →
                  </Button>
                </div>
              </div>
            </div>
          )}

          <!-- Recent Posts Grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            {paginatedPosts.slice(1).map(post => (
              <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-start justify-between mb-3">
                  <Badge variant="secondary" size="sm">{post.data.category}</Badge>
                  <span class="text-xs text-gray-500">{post.data.readingTime || 5} min</span>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2">
                  <a href={`/blog/${post.slug}`} class="hover:text-primary-600 transition-colors">
                    {post.data.title}
                  </a>
                </h3>
                <p class="text-sm text-gray-600 mb-4 line-clamp-2">
                  {post.data.description}
                </p>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-gray-500">{formatDate(post.data.publishDate)}</span>
                  <a href={`/blog/${post.slug}`} class="text-primary-600 hover:text-primary-700 font-medium text-sm flex items-center gap-1">
                    Read
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </a>
                </div>
              </div>
            ))}
          </div>

          <!-- Pagination -->
          {totalPages > 1 && (
            <div class="mt-8 sm:mt-12 flex items-center justify-center gap-2">
              <Button variant="outline" size="sm" disabled={currentPage === 1}>
                ← Previous
              </Button>
              <span class="px-4 py-2 text-sm font-medium text-gray-700">
                Page {currentPage} of {totalPages}
              </span>
              <Button 
                href={currentPage < totalPages ? `/blog/page/${currentPage + 1}` : '#'} 
                variant="outline" 
                size="sm" 
                disabled={currentPage >= totalPages}
              >
                Next →
              </Button>
            </div>
          )}
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <div class="sticky top-24 space-y-6">
            <!-- Search -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
              <h3 class="font-bold text-gray-900 mb-4">Search Articles</h3>
              <div class="relative">
                <input 
                  type="search" 
                  placeholder="Search blog posts..."
                  class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
                <button 
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  aria-label="Search blog posts"
                  type="button"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Categories -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
              <h3 class="font-bold text-gray-900 mb-4">Categories</h3>
              <ul class="space-y-2">
                {categories.slice(0, 8).map(category => (
                  <li>
                    <a 
                      href={category.name === 'All Posts' ? '/blog' : `/blog/category/${getCategorySlug(category.name)}`} 
                      class="flex items-center justify-between text-gray-600 hover:text-primary-600 transition-colors"
                    >
                      <span class="text-sm">{category.name}</span>
                      <span class="text-xs text-gray-400">({category.count})</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>

            <!-- Popular Posts -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
              <h3 class="font-bold text-gray-900 mb-4">Popular Articles</h3>
              <ul class="space-y-3">
                {popularPosts.map((post, index) => (
                  <li class="flex items-start gap-3">
                    <span class="text-lg font-bold text-primary-600 flex-shrink-0">
                      {index + 1}
                    </span>
                    <a 
                      href={`/blog/${post.slug}`} 
                      class="text-sm text-gray-600 hover:text-primary-600 transition-colors line-clamp-2"
                    >
                      {post.data.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>

            <!-- Emergency CTA -->
            <div class="bg-emergency-50 border-2 border-emergency-200 rounded-lg p-6">
              <div class="text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-emergency-100 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-emergency-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <h3 class="font-bold text-gray-900 mb-2">HVAC Emergency?</h3>
                <p class="text-sm text-gray-600 mb-4">
                  24/7 emergency service available
                </p>
                <Button href="tel:9403905676" variant="emergency" size="sm" class="w-full">
                  Call (940) 390-5676
                </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Newsletter Section -->
  <section class="section-full bg-gray-50">
    <div class="site-container py-12 sm:py-16">
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">
          Stay Informed with HVAC Tips
        </h2>
        <p class="text-gray-700 mb-6">
          Get monthly maintenance reminders and exclusive offers
        </p>
        <form class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
          <input 
            type="email" 
            placeholder="Enter your email" 
            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            required
          />
          <Button type="submit" variant="primary" size="lg">
            Subscribe
          </Button>
        </form>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="section-full bg-primary-600">
    <div class="site-container py-12 sm:py-16">
      <div class="text-center">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-4">
          Need Professional HVAC Service?
        </h2>
        <p class="text-base sm:text-lg text-white/90 mb-8 max-w-2xl mx-auto">
          Our expert technicians are ready to help with all your heating and cooling needs
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <Button href="/contact" variant="secondary" size="lg">
            Get Free Quote
          </Button>
          <Button href="/services" variant="outline" size="lg" class="!text-white !border-white hover:!bg-white hover:!text-blue-600">
            View Services
          </Button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Line clamp utilities */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>