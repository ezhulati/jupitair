---
// Helper page for Zoho Calendar OAuth setup
---

<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Zoho Calendar OAuth Setup Helper</title>
 <style>
 body { 
 font-family: Arial, sans-serif; 
 max-width: 900px; 
 margin: 20px auto; 
 padding: 20px;
 background: #f8f9fa;
 line-height: 1.6;
 }
 .container {
 background: white;
 padding: 30px;
 border-radius: 8px;
 box-shadow: 0 2px 10px rgba(0,0,0,0.1);
 }
 .step {
 background: #f8f9fa;
 border-left: 4px solid #0066cc;
 padding: 20px;
 margin: 20px 0;
 }
 .code-box {
 background: #2d3748;
 color: #e2e8f0;
 border-radius: 4px;
 padding: 15px;
 margin: 10px 0;
 font-family: monospace;
 overflow-x: auto;
 }
 .form-section {
 background: #e7f3ff;
 padding: 20px;
 border-radius: 8px;
 margin: 20px 0;
 }
 input[type="text"] {
 width: 100%;
 padding: 10px;
 margin: 5px 0;
 border: 1px solid #ddd;
 border-radius: 4px;
 font-family: monospace;
 }
 button {
 background: #0066cc;
 color: white;
 padding: 12px 24px;
 border: none;
 border-radius: 4px;
 cursor: pointer;
 font-size: 16px;
 }
 button:hover {
 background: #0052a3;
 }
 .warning {
 background: #fff3cd;
 border: 1px solid #ffeaa7;
 color: #856404;
 padding: 15px;
 border-radius: 4px;
 margin: 15px 0;
 }
 .success {
 background: #d4edda;
 border: 1px solid #c3e6cb;
 color: #155724;
 padding: 15px;
 border-radius: 4px;
 margin: 15px 0;
 }
 </style>
</head>
<body>
 <div class="max-w-7xl overflow-x-hidden container">
 <h1>üîê Zoho Calendar OAuth Setup</h1>
 <p>This helper will guide you through setting up Zoho Calendar integration for your HVAC booking system.</p>

 <div class="step">
 <h2>Step 1: Create Zoho OAuth Application</h2>
 <p>1. Go to <a href="https://api-console.zoho.com/" target="_blank">Zoho API Console</a></p>
 <p>2. Click "Add Client" ‚Üí Select "Server-based Applications"</p>
 <p>3. Fill in these details:</p>
 <ul>
 <li><strong>Client Name:</strong> Jupitair HVAC Calendar Integration</li>
 <li><strong>Homepage URL:</strong> https://jupitairhvac.com</li>
 <li><strong>Authorized Redirect URIs:</strong></li>
 </ul>
 
 <div class="code-box">https://jupitairhvac.com/oauth/callback</div>
 
 <div class="warning">
 <strong>For development:</strong> Also add <code>http://localhost:4323/oauth/callback</code> to test locally (or whatever port Astro uses)
 </div>
 </div>

 <div class="step">
 <h2>Step 2: Get Your Client Credentials</h2>
 <p>After creating the app, copy your <strong>Client ID</strong> and <strong>Client Secret</strong> from the Zoho console.</p>
 </div>

 <div class="form-section">
 <h2>Step 3: Generate Authorization URL</h2>
 <p>Enter your Client ID to generate the authorization URL:</p>
 
 <label for="clientId">Client ID:</label>
 <input type="text" id="clientId" placeholder="1000.ABC123XYZ..." />
 
 <br><br>
 <button onclick="generateAuthUrl()">Generate Authorization URL</button>
 
 <div id="authUrlResult" style="display: none;">
 <h3>Click this link to authorize:</h3>
 <div class="code-box">
 <a id="authUrl" href="#" target="_blank" style="color: #64b5f6; text-decoration: none;" aria-label="Authorization URL will appear here">Click to generate authorization URL</a>
 </div>
 <div class="success">
 <strong>Next:</strong> Click the link above, log in to Zoho, and authorize the app. You'll be redirected back with an authorization code.
 </div>
 </div>
 </div>

 <div class="step">
 <h2>Step 4: Exchange Code for Tokens</h2>
 <p>After authorization, you'll get a code. Use this curl command to get your refresh token:</p>
 
 <div class="code-box" id="curlCommand">
curl -X POST https://accounts.zoho.com/oauth/v2/token \
 -H "Content-Type: application/x-www-form-urlencoded" \
 -d "grant_type=authorization_code&client_id=YOUR_CLIENT_ID&client_secret=YOUR_CLIENT_SECRET&redirect_uri=https://jupitairhvac.com/oauth/callback&code=YOUR_AUTHORIZATION_CODE"
 </div>
 </div>

 <div class="step">
 <h2>Step 5: Update Environment Variables</h2>
 <p>Add these to your <code>.env</code> file:</p>
 
 <div class="code-box">
# Zoho Calendar API Configuration
ZOHO_CLIENT_ID=your_client_id_here
ZOHO_CLIENT_SECRET=your_client_secret_here
ZOHO_REFRESH_TOKEN=your_refresh_token_here
 </div>
 </div>

 <div class="success">
 <h3>üéâ That's it!</h3>
 <p>Once you've completed these steps, your calendar integration will be active and customers will see real-time availability when booking appointments.</p>
 </div>

 <hr style="margin: 30px 0;">
 <p><small><strong>Need help?</strong> Check the complete documentation in <code>ZOHO_CALENDAR_SETUP.md</code></small></p>
 </div>

 <script>
 function generateAuthUrl() {
 console.log('generateAuthUrl function called');
 
 const clientIdElement = document.getElementById('clientId');
 console.log('clientId element:', clientIdElement);
 
 if (!clientIdElement) {
 alert('Client ID input field not found!');
 return;
 }
 
 const clientId = clientIdElement.value.trim();
 console.log('Client ID value:', clientId);
 
 if (!clientId) {
 alert('Please enter your Client ID');
 return;
 }
 
 const baseUrl = window.location.hostname === 'localhost' 
 ? `${window.location.protocol}//${window.location.host}/oauth/callback`
 : 'https://jupitairhvac.com/oauth/callback';
 
 console.log('Base URL:', baseUrl);
 
 const authUrl = `https://accounts.zoho.com/oauth/v2/auth?scope=ZohoCalendar.calendar.ALL&client_id=${encodeURIComponent(clientId)}&response_type=code&access_type=offline&redirect_uri=${encodeURIComponent(baseUrl)}`;
 
 console.log('Auth URL:', authUrl);
 
 const authUrlElement = document.getElementById('authUrl');
 const authUrlResultElement = document.getElementById('authUrlResult');
 const curlCommandElement = document.getElementById('curlCommand');
 
 console.log('Elements found:', {
 authUrl: !!authUrlElement,
 authUrlResult: !!authUrlResultElement,
 curlCommand: !!curlCommandElement
 });
 
 if (authUrlElement && authUrlResultElement) {
 authUrlElement.href = authUrl;
 authUrlElement.textContent = authUrl;
 authUrlResultElement.style.display = 'block';
 
 console.log('Updated auth URL elements');
 } else {
 alert('Required elements not found on page');
 return;
 }
 
 // Update curl command
 if (curlCommandElement) {
 const curlCommand = `curl -X POST https://accounts.zoho.com/oauth/v2/token \\
 -H "Content-Type: application/x-www-form-urlencoded" \\
 -d "grant_type=authorization_code&client_id=${clientId}&client_secret=YOUR_CLIENT_SECRET&redirect_uri=${baseUrl}&code=YOUR_AUTHORIZATION_CODE"`;
 
 curlCommandElement.textContent = curlCommand;
 console.log('Updated curl command');
 }
 
 console.log('Function completed successfully');
 }
 
 // Test that the function exists
 window.addEventListener('load', function() {
 console.log('Page loaded, generateAuthUrl function exists:', typeof generateAuthUrl === 'function');
 
 const button = document.querySelector('button');
 console.log('Button found:', !!button);
 if (button) {
 console.log('Button onclick:', button.onclick);
 console.log('Button addEventListener test...');
 
 // Add backup event listener
 button.addEventListener('click', function(e) {
 console.log('Button clicked via addEventListener');
 e.preventDefault();
 generateAuthUrl();
 });
 }
 });
 
 // Auto-detect if we're on localhost and show appropriate message
 window.addEventListener('load', function() {
 if (window.location.hostname === 'localhost') {
 const callbackUrl = `${window.location.protocol}//${window.location.host}/oauth/callback`;
 const warning = document.createElement('div');
 warning.className = 'warning';
 warning.innerHTML = `<strong>Development Mode:</strong> Using localhost callback URL. Make sure you added <code>${callbackUrl}</code> to your Zoho OAuth app.`;
 document.querySelector('.container').insertBefore(warning, document.querySelector('.step'));
 }
 });
 </script>
</body>
</html>