---
// OAuth callback handler for Zoho Calendar setup
const url = new URL(Astro.request.url);
const { searchParams } = url;
const code = searchParams.get('code');
const error = searchParams.get('error');
const error_description = searchParams.get('error_description');
const state = searchParams.get('state');

// Get all URL parameters for debugging
const allParams = {};
for (const [key, value] of searchParams.entries()) {
  allParams[key] = value;
}

let message = '';
let success = false;
let debugInfo = '';

if (error) {
  message = `OAuth Error: ${error}`;
  if (error_description) {
    message += ` - ${error_description}`;
  }
} else if (code) {
  message = `Authorization code received: ${code}`;
  success = true;
} else {
  message = 'No authorization code received';
  debugInfo = `Full URL: ${url.toString()}\nURL Parameters: ${JSON.stringify(allParams, null, 2)}`;
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zoho Calendar OAuth Callback</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 50px auto; 
      padding: 20px;
      background: #f8f9fa;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .code-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
      word-break: break-all;
    }
    .next-steps {
      background: #e7f3ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="max-w-7xl overflow-x-hidden container">
    <h1>Zoho Calendar OAuth Setup</h1>
    
    {success ? (
      <div>
        <p class="success">✅ Authorization successful!</p>
        <p>Copy this authorization code to complete the setup:</p>
        <div class="code-box">{code}</div>
        
        <div class="next-steps">
          <h3>Next Steps:</h3>
          <p>1. Copy the authorization code above</p>
          <p>2. Use it in the token exchange request (see ZOHO_CALENDAR_SETUP.md)</p>
          <p>3. Exchange this code for a refresh token using the instructions below</p>
        </div>

        <h3>Token Exchange Command:</h3>
        <div class="code-box">
curl -X POST https://accounts.zoho.com/oauth/v2/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code&client_id=YOUR_CLIENT_ID&client_secret=YOUR_CLIENT_SECRET&redirect_uri=https://jupitairhvac.com/oauth/callback&code={code}"
        </div>
        
        <p><strong>Replace YOUR_CLIENT_ID and YOUR_CLIENT_SECRET with your actual values from the Zoho API Console.</strong></p>
      </div>
    ) : (
      <div>
        <p class="error">❌ {message}</p>
        <p>Please check your OAuth application configuration and try again.</p>
        
        {debugInfo && (
          <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0;">
            <h3>Debug Information:</h3>
            <pre style="font-size: 12px; overflow-x: auto;">{debugInfo}</pre>
          </div>
        )}
        
        <h3>What to check:</h3>
        <ul>
          <li><strong>Did you complete the Zoho login?</strong> Make sure you entered your credentials and clicked "Allow"</li>
          <li><strong>Did you authorize the app?</strong> Zoho should show permissions and ask you to approve</li>
          <li><strong>Check for popup blockers</strong> - they might be interfering</li>
          <li>Redirect URI mismatch - make sure it's exactly: <code>http://localhost:4323/oauth/callback</code></li>
          <li>Invalid Client ID or scope</li>
        </ul>
        
        <p><a href="/oauth/simple-setup.html">← Try OAuth setup again</a></p>
      </div>
    )}
    
    <hr style="margin: 30px 0;">
    <p><small>For development, you can also use localhost URLs. Update your Zoho OAuth app redirect URI to: <code>http://localhost:4321/oauth/callback</code></small></p>
  </div>
</body>
</html>