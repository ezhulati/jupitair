---
import BaseLayout from './BaseLayout.astro';
import PremiumCard from '../components/ui/PremiumCard.astro';
import Badge from '../components/ui/Badge.astro';
import Button from '../components/ui/Button.astro';
import PremiumButton from '../components/ui/PremiumButton.astro';
import DynamicSchema from '../components/seo/DynamicSchema.astro';
import { Image } from 'astro:assets';

export interface Props {
  frontmatter: {
    title: string;
    description: string;
    author: string;
    publishDate: Date;
    updateDate?: Date;
    heroImage?: string;
    heroImageAlt?: string;
    category: string;
    subcategory?: string;
    tags: string[];
    featured: boolean;
    metaTitle?: string;
    metaDescription?: string;
    primaryKeyword: string;
    secondaryKeywords: string[];
    canonicalURL?: string;
    readingTime?: number;
    tableOfContents?: boolean;
    schemaTypes?: string[];
    ctaText?: string;
    ctaLink?: string;
    relatedPosts?: string[];
    internalLinks?: string[];
  };
}

const { frontmatter } = Astro.props;
const formattedPublishDate = new Date(frontmatter.publishDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
const formattedUpdateDate = frontmatter.updateDate ? new Date(frontmatter.updateDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) : null;

// Generate breadcrumb data
const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Blog', url: '/blog' },
  { name: frontmatter.category, url: `/blog/category/${frontmatter.category.toLowerCase().replace(/\s+/g, '-')}` },
  { name: frontmatter.title, url: '#' }
];

// Schema data for blog post
const blogSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": frontmatter.title,
  "description": frontmatter.description,
  "author": {
    "@type": "Organization",
    "name": frontmatter.author,
    "url": "https://jupitairhvac.com"
  },
  "datePublished": frontmatter.publishDate,
  "dateModified": frontmatter.updateDate || frontmatter.publishDate,
  "image": frontmatter.heroImage ? `https://jupitairhvac.com${frontmatter.heroImage}` : undefined,
  "publisher": {
    "@type": "Organization",
    "name": "Jupitair HVAC",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jupitairhvac.com/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": frontmatter.canonicalURL || `https://jupitairhvac.com/blog/${frontmatter.title.toLowerCase().replace(/\s+/g, '-')}`
  },
  "keywords": [frontmatter.primaryKeyword, ...frontmatter.secondaryKeywords].join(', ')
};
---

<BaseLayout 
  title={frontmatter.metaTitle || `${frontmatter.title} | Jupitair HVAC Blog`}
  description={frontmatter.metaDescription || frontmatter.description}
  keywords={[frontmatter.primaryKeyword, ...frontmatter.secondaryKeywords].join(', ')}
  canonical={frontmatter.canonicalURL}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(blogSchema)} />
  
  <!-- Breadcrumbs Schema -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://jupitairhvac.com/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Blog",
          "item": "https://jupitairhvac.com/blog"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "{frontmatter.category}",
          "item": "https://jupitairhvac.com/blog/category/{frontmatter.category.toLowerCase().replace(/\s+/g, '-')}"
        },
        {
          "@type": "ListItem",
          "position": 4,
          "name": "{frontmatter.title}"
        }
      ]
    }
  </script>

  <article class="max-w-6xl mx-auto px-4 py-12">
    <!-- Breadcrumbs -->
    <nav class="mb-8 overflow-x-auto" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm whitespace-nowrap">
        {breadcrumbs.slice(0, -1).map((crumb, index) => (
          <>
            {index > 0 && <span class="text-gray-400">/</span>}
            <li>
              <a href={crumb.url} class="text-gray-600 hover:text-gray-900 transition-colors">
                {crumb.name}
              </a>
            </li>
          </>
        ))}
      </ol>
    </nav>

    <!-- Article Header -->
    <header class="mb-12">
      <div class="min-w-0 flex flex-wrap gap-2 mb-4">
        <Badge variant="primary">{frontmatter.category}</Badge>
        {frontmatter.subcategory && (
          <Badge variant="secondary">{frontmatter.subcategory}</Badge>
        )}
        {frontmatter.featured && (
          <Badge variant="success">Featured</Badge>
        )}
      </div>
      
      <h1 class="break-words text-4xl md:text-5xl font-bold text-gray-900 mb-4">
        {frontmatter.title}
      </h1>
      
      <p class="break-words text-xl text-gray-700 mb-6">
        {frontmatter.description}
      </p>
      
      <div class="min-w-0 flex flex-wrap items-center gap-4 text-sm text-gray-600">
        <div class="min-w-0 flex items-center gap-2">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
          </svg>
          <span>{frontmatter.author}</span>
        </div>
        <div class="min-w-0 flex items-center gap-2">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
          </svg>
          <time datetime={frontmatter.publishDate.toISOString()}>
            {formattedPublishDate}
          </time>
        </div>
        {formattedUpdateDate && (
          <div class="min-w-0 flex items-center gap-2">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
            </svg>
            <span>Updated: {formattedUpdateDate}</span>
          </div>
        )}
        {frontmatter.readingTime && (
          <div class="min-w-0 flex items-center gap-2">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
            </svg>
            <span>{frontmatter.readingTime} min read</span>
          </div>
        )}
      </div>
    </header>

    <!-- Hero Image -->
    {frontmatter.heroImage && (
      <div class="mb-12 rounded-2xl overflow-hidden shadow-xl">
        <img 
          src={frontmatter.heroImage} 
          alt={frontmatter.heroImageAlt || frontmatter.title}
          class="w-full h-auto"
          loading="eager"
        />
      </div>
    )}

    <!-- Table of Contents -->
    {frontmatter.tableOfContents && (
      <PremiumCard variant="elevated" padding="lg" class="mb-12">
        <h2 class="break-words min-w-0 text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 mr-2 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
          Table of Contents
        </h2>
        <div id="toc" class="overflow-x-hidden">
          <!-- TOC will be generated by client-side script -->
        </div>
      </PremiumCard>
    )}

    <!-- Main Content -->
    <div class="min-w-0 grid lg:grid-cols-3 gap-12">
      <div class="lg:col-span-2">
        <div class="prose prose-lg max-w-none
          prose-headings:font-bold prose-headings:text-gray-900 
          prose-h1:text-3xl sm:prose-h1:text-4xl prose-h1:mt-8 prose-h1:mb-6 prose-h1:leading-tight
          prose-h2:text-2xl sm:prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:leading-snug
          prose-h3:text-xl sm:prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:leading-snug
          prose-h4:text-lg sm:prose-h4:text-xl prose-h4:mt-6 prose-h4:mb-3
          prose-p:text-base sm:prose-p:text-lg prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
          prose-a:text-blue-600 hover:prose-a:text-blue-700 prose-a:underline prose-a:underline-offset-2
          prose-strong:text-gray-900 prose-strong:font-semibold
          prose-ul:my-6 prose-ul:list-disc prose-ul:pl-6 prose-ul:space-y-2
          prose-ol:my-6 prose-ol:list-decimal prose-ol:pl-6 prose-ol:space-y-2
          prose-li:text-gray-700 prose-li:leading-relaxed
          prose-blockquote:border-l-4 prose-blockquote:border-blue-500 prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-700 prose-blockquote:my-8
          prose-code:bg-gray-100 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-sm prose-code:text-gray-800 prose-code:font-mono
          prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:overflow-x-auto prose-pre:rounded-lg prose-pre:p-4 prose-pre:my-8
          prose-table:w-full prose-table:border-collapse prose-table:my-8
          prose-th:bg-gray-100 prose-th:text-left prose-th:p-3 prose-th:border prose-th:border-gray-300 prose-th:font-semibold
          prose-td:border prose-td:border-gray-300 prose-td:p-3
          prose-img:rounded-lg prose-img:shadow-lg prose-img:my-8 prose-img:w-full
          prose-hr:border-gray-300 prose-hr:my-12">
          <slot />
        </div>

        <!-- Author Bio -->
        <div class="mt-16 mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
          <h3 class="font-bold text-gray-900 mb-2">About the Author</h3>
          <p class="text-gray-700">
            The Jupitair HVAC Team consists of licensed HVAC technicians and comfort specialists with over 15 years of experience serving North Texas. We're committed to providing honest, expert advice to help homeowners make informed decisions about their heating and cooling systems.
          </p>
        </div>

        <!-- Tags -->
        {frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="mt-8">
            <h3 class="font-bold text-gray-900 mb-4">Topics:</h3>
            <div class="min-w-0 flex flex-wrap gap-2">
              {frontmatter.tags.map(tag => (
                <span 
                  class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm"
                >
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-1">
        <!-- Sticky CTA -->
        <div class="sticky top-24">
          <PremiumCard variant="elevated" padding="lg" class="mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Need HVAC Service?</h3>
            <p class="text-gray-700 mb-6">
              Get fast, reliable service from North Texas's trusted HVAC experts.
            </p>
            <div class="space-y-3">
              <PremiumButton 
                href="tel:9403905676" 
                variant="premium" 
                size="lg" 
                class="w-full justify-center"
              >
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                </svg>
                Call (940) 390-5676
              </PremiumButton>
              <Button 
                href={frontmatter.ctaLink || '/schedule'} 
                variant="outline" 
                size="lg" 
                class="w-full justify-center"
              >
                {frontmatter.ctaText || 'Schedule Online'}
              </Button>
            </div>
            <p class="text-xs text-gray-600 mt-4 text-center">
              24/7 Emergency Service Available
            </p>
          </PremiumCard>

          <!-- Related Posts -->
          {frontmatter.relatedPosts && frontmatter.relatedPosts.length > 0 && (
            <PremiumCard variant="default" padding="lg">
              <h3 class="text-lg font-bold text-gray-900 mb-4">Related Articles</h3>
              <ul class="space-y-3">
                {frontmatter.relatedPosts.slice(0, 5).map(post => (
                  <li>
                    <a 
                      href={`/blog/${post}`}
                      class="text-blue-600 hover:text-blue-700 hover:underline block"
                    >
                      {post.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </a>
                  </li>
                ))}
              </ul>
            </PremiumCard>
          )}
        </div>
      </aside>
    </div>
  </article>

  <!-- Generate TOC Script -->
  {frontmatter.tableOfContents && (
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const tocContainer = document.getElementById('toc');
        const headings = document.querySelectorAll('.prose h2, .prose h3');
        
        if (tocContainer && headings.length > 0) {
          const tocList = document.createElement('ul');
          tocList.className = 'space-y-2';
          
          headings.forEach((heading, index) => {
            const id = heading.id || `heading-${index}`;
            heading.id = id;
            
            const li = document.createElement('li');
            li.className = heading.tagName === 'H3' ? 'ml-4' : '';
            
            const link = document.createElement('a');
            link.href = `#${id}`;
            link.textContent = heading.textContent;
            link.className = 'text-blue-600 hover:text-blue-700 hover:underline';
            
            li.appendChild(link);
            tocList.appendChild(li);
          });
          
          tocContainer.appendChild(tocList);
        }
      });
    </script>
  )}
</BaseLayout>
